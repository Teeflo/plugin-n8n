# n8n Connect для Jeedom

Этот плагин позволяет вам управлять и отслеживать ваши рабочие процессы **n8n** непосредственно из интерфейса домашней автоматизации Jeedom. Он предлагает простую и эффективную интеграцию для запуска рабочих процессов, их активации/деактивации и проверки их состояния.

## Функции

*   **Настройка экземпляра n8n:** Легко подключите ваш Jeedom к вашему экземпляру n8n через его URL и ключ API.
*   **Управление рабочими процессами:** Создавайте оборудование Jeedom для каждого рабочего процесса n8n, которым вы хотите управлять.
*   **Команды действий:**
    *   **Активировать/Деактивировать:** Измените статус выполнения ваших рабочих процессов n8n.
    *   **Запустить (через Webhook):** Запустите рабочий процесс n8n, отправив запрос на его настроенный URL вебхука. Эта команда появляется только в том случае, если для оборудования настроен вебхук.
*   **Информационная команда:**
    *   **Статус:** Получите статус (активен/неактивен) вашего рабочего процесса n8n.
*   **Уведомления об ошибках рабочего процесса:** Получайте уведомления в Jeedom, когда рабочий процесс n8n завершается с ошибкой, что позволяет проактивно управлять проблемами.
*   **Упрощенный выбор:** Выберите свои рабочие процессы n8n из выпадающего списка или введите их ID вручную.
*   **Подробное логирование:** Точные логи для облегчения диагностики в случае проблем.

## Предварительные требования

1.  Функциональный экземпляр [n8n](https://n8n.io/), доступный из вашего Jeedom.
2.  REST API n8n должен быть включен на вашем экземпляре.
3.  Действительный ключ API n8n с необходимыми разрешениями для управления рабочими процессами.
4.  Jeedom версии 4.2.0 или выше.
5.  Расширение PHP `cURL` должно быть установлено и включено в вашей системе Jeedom.

## Установка

1.  Установите плагин "n8n Connect" непосредственно из Jeedom Market.
2.  После установки активируйте плагин в **Плагины > Управление плагинами**.

## Конфигурация

### 1. Глобальная конфигурация плагина

Доступ к глобальной конфигурации плагина осуществляется через **Плагины > Управление плагинами > n8n Connect > Конфигурация**.

*   **URL экземпляра n8n:** Введите полный адрес вашего экземпляра n8n (например, `https://my.n8n.local` или `http://192.168.1.100:5678`).
*   **Ключ API:** Введите ваш ключ API n8n, сгенерированный в n8n (**Настройки > API**).
*   Нажмите кнопку **"Тест"**, чтобы проверить подключение к вашему экземпляру n8n.

### 2. Конфигурация оборудования (рабочих процессов)

Для каждого рабочего процесса n8n, которым вы хотите управлять:

1.  Перейдите в **Плагины > n8n Connect**.
2.  Нажмите **"Добавить"**, чтобы создать новое оборудование.
3.  **Имя оборудования:** Дайте осмысленное имя вашему оборудованию Jeedom (например, "Рабочий процесс Освещение гостиной").
4.  **Рабочий процесс:**
    *   Нажмите кнопку обновления (<i class="fas fa-sync"></i>), чтобы загрузить список доступных рабочих процессов n8n.
    *   Выберите нужный рабочий процесс из выпадающего списка.
    *   Если список не загружается (например, из-за проблемы с подключением к API), появится поле для ручного ввода ID рабочего процесса. Вы можете найти ID вашего рабочего процесса в интерфейсе n8n.
5.  **URL вебхука (необязательно):** Если вы хотите запустить этот рабочий процесс с помощью команды "Запустить", вставьте сюда URL вебхука вашего рабочего процесса n8n. Этот URL предоставляется узлом "Webhook" вашего рабочего процесса n8n.
6.  Настройте **Общие параметры** (Родительский объект, Категория, Активировать/Видимый) по мере необходимости.
7.  Нажмите **"Сохранить"**. Команды "Активировать", "Деактивировать" и "Статус" будут созданы автоматически. Команда "Запустить" будет добавлена, если был указан URL вебхука.

## Доступные команды

После настройки оборудования будут доступны следующие команды:

*   **Активировать:** Активирует соответствующий рабочий процесс в n8n.
*   **Деактивировать:** Деактивирует соответствующий рабочий процесс в n8n.
*   **Запустить:** Отправляет HTTP POST запрос на URL вебхука, настроенный для рабочего процесса. Эта команда видна только в том случае, если в конфигурации оборудования указан "URL вебхука".
*   **Статус:** Бинарная информационная команда, указывающая, активен (1) или неактивен (0) рабочий процесс в n8n.

## Устранение неполадок

### Ошибка HTTP 401 "unauthorized"

Эта ошибка указывает на проблему аутентификации при попытке подключения к API n8n.

*   **Проверьте свою конфигурацию:** Убедитесь, что **URL экземпляра n8n** и **Ключ API** правильно введены в глобальной конфигурации плагина.
*   **Проверьте подключение:** Используйте кнопку **"Тест"** на этой же странице, чтобы проверить свои учетные данные.
*   **Проверьте n8n:**
    *   Убедитесь, что REST API включен в n8n (**Настройки > API**).
    *   Убедитесь, что ваш ключ API n8n действителен и не истек, а также что у него есть необходимые разрешения.
    *   Убедитесь, что ваш экземпляр n8n запущен и доступен из Jeedom.
*   **Сетевое подключение:** Проверьте брандмауэры или проблемы с сетью, которые могут помешать Jeedom обмениваться данными с n8n.

### Общие сообщения об ошибках

*   **"Отсутствует URL вебхука":** Команда "Запустить" была выполнена, но для этого оборудования не настроен URL вебхука.
*   **"Ошибка вебхука: Запрошенный вебхук ... не зарегистрирован":** Рабочий процесс не активен в n8n, или URL вебхука неверен. Убедитесь, что рабочий процесс активирован в n8n и URL точен.
*   **"Время ожидания истекло":** Jeedom не смог связаться с вашим экземпляром n8n в отведенное время. Убедитесь, что n8n находится в сети и доступен.
*   **"Неверный ответ API n8n":** API n8n вернул неожиданный ответ.

### Диагностические логи

Для получения более подробной информации обратитесь к логам плагина:
1.  Перейдите в **Инструменты > Логи**.
2.  Выберите плагин **n8nconnect**.
3.  Ищите недавние сообщения об ошибках, чтобы определить причину проблемы.

## Уведомления об ошибках n8n в Jeedom

Чтобы получать уведомления об ошибках рабочих процессов n8n непосредственно в Jeedom, вы можете настроить глобальный "Рабочий процесс ошибок" в n8n, который будет отправлять HTTP-запрос в Jeedom.

### Конфигурация в n8n

1.  **Создайте новый рабочий процесс** в n8n (или используйте существующий рабочий процесс, предназначенный для ошибок).
2.  Добавьте узел **"Webhook"** в качестве триггера. Настройте его для прослушивания `POST`-запросов.
3.  Добавьте узел **"HTTP-запрос"** после узла "Webhook".
    *   **Метод:** `POST`
    *   **URL:** `http://ВАШ_IP_JEEDOM/plugins/n8nconnect/core/ajax/n8nconnect.ajax.php?action=receiveErrorNotification`
        *   Замените `ВАШ_IP_JEEDOM` на IP-адрес или доменное имя вашей установки Jeedom.
    *   **Тип содержимого тела:** `JSON`
    *   **Тело JSON:** Вы можете отправить любые соответствующие данные JSON. Например, чтобы отправить информацию об ошибке из завершившегося с ошибкой рабочего процесса, вы можете использовать выражение, подобное этому:
        ```json
        {
          "workflowName": "{{ $json.workflow.name }}",
          "workflowId": "{{ $json.workflow.id }}",
          "executionId": "{{ $json.id }}",
          "error": "{{ $json.error.message }}",
          "stackTrace": "{{ $json.error.stack }}"
        }
        ```
        Эти переменные (`$json.workflow.name` и т. д.) доступны в контексте рабочего процесса ошибок n8n.
4.  **Активируйте этот рабочий процесс** в n8n.
5.  **Настройте этот рабочий процесс как глобальный "Рабочий процесс ошибок":**
    *   В n8n перейдите в **Настройки > Обработка ошибок рабочего процесса**.
    *   Выберите только что созданный рабочий процесс из выпадающего списка "Рабочий процесс ошибок".

### Обработка в Jeedom

Плагин n8n Connect будет получать эти уведомления и записывать их в логи плагина (`Инструменты > Логи > n8nconnect`). Затем вы можете использовать сценарии Jeedom для анализа этих логов и запуска действий (уведомлений, предупреждений и т. д.) на основе содержимого сообщений об ошибках.