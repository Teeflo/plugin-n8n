# Конфигурация и устранение неполадок плагина n8n Connect

Этот документ содержит подробное руководство по настройке плагина n8n Connect в Jeedom, а также решения распространенных проблем, с которыми вы можете столкнуться.

## Оглавление

1.  [Предварительные требования](#1-предварительные-требования)
2.  [Установка плагина](#2-установка-плагина)
3.  [Глобальная конфигурация плагина](#3-глобальная-конфигурация-плагина)
    *   [Доступ к конфигурации](#доступ-к-конфигурации)
    *   [Параметры подключения n8n](#параметры-подключения-n8n)
    *   [Тест подключения](#тест-подключения)
4.  [Конфигурация оборудования (рабочих процессов)](#4-конфигурация-оборудования-рабочих-процессов)
    *   [Создание нового оборудования](#создание-нового-оборудования)
    *   [Общие параметры оборудования](#общие-параметры-оборудования)
    *   [Специфические параметры рабочего процесса](#специфические-параметры-рабочего-процесса)
    *   [Сохранение оборудования](#сохранение-оборудования)
5.  [Доступные команды](#5-доступные-команды)
    *   [Команды действий](#команды-действий)
    *   [Информационные команды](#информационные-команды)
6.  [Устранение неполадок и распространенные ошибки](#6-устранение-неполадок-и-распространенные-ошибки)
    *   [Ошибка HTTP 401 "несанкционированный доступ"](#ошибка-http-401-несанкционированный-доступ)
    *   ["Отсутствует URL вебхука"](#отсутствует-url-вебхука)
    *   ["Ошибка вебхука: Запрошенный вебхук ... не зарегистрирован"](#ошибка-вебхука-запрошенный-вебхук--не-зарегистрирован)
    *   ["Время ожидания истекло"](#время-ожидания-истекло)
    *   ["Неверный ответ API n8n"](#неверный-ответ-api-n8n)
    *   [Диагностические логи](#диагностические-логи)
7.  [Поддержка](#7-поддержка)

---

## 1. Предварительные требования

Перед началом настройки убедитесь, что выполнены следующие условия:

*   **Экземпляр n8n:** Функциональный экземпляр n8n, доступный из вашей установки Jeedom. Это может быть локальный экземпляр, в частной сети или облачный экземпляр.
*   **REST API n8n включен:** REST API должен быть включен в настройках вашего экземпляра n8n. Обычно вы найдете его в разделе `Настройки > API`.
*   **Ключ API n8n:** Действительный ключ API, сгенерированный в n8n. Этот ключ должен иметь необходимые разрешения для:
    *   Перечисления рабочих процессов.
    *   Активации/деактивации рабочих процессов.
    *   (Необязательно) Выполнения рабочих процессов через API, если вы используете этот метод (хотя плагин предпочитает вебхуки для запуска).
*   **Jeedom:** Установка Jeedom версии 4.2.0 или выше.
*   **Расширение PHP cURL:** Расширение PHP `cURL` необходимо для связи плагина с API n8n. Убедитесь, что оно установлено и включено в вашей системе Jeedom.

## 2. Установка плагина

1.  **Через Jeedom Market:** Откройте интерфейс Jeedom, затем перейдите в `Плагины > Управление плагинами > Market`. Найдите "n8n Connect" и установите его.
2.  **Активация:** После завершения установки плагин появится в вашем списке плагинов. Нажмите кнопку `Активировать` (обычно значок зеленой галочки), чтобы сделать его работоспособным.

## 3. Глобальная конфигурация плагина

Этот шаг устанавливает соединение между вашим Jeedom и вашим экземпляром n8n.

### Доступ к конфигурации

*   В Jeedom перейдите в `Плагины > Управление плагинами`.
*   Найдите "n8n Connect" в списке и нажмите на его значок (обычно гаечный ключ) или на кнопку `Конфигурация`.

### Параметры подключения n8n

На странице конфигурации вы найдете следующие поля:

*   **URL экземпляра n8n:**
    *   Введите полный адрес вашего экземпляра n8n.
    *   **Примеры:**
        *   `https://my.n8n.local` (для экземпляра с SSL/TLS)
        *   `http://192.168.1.100:5678` (для локального экземпляра без SSL/TLS, с портом по умолчанию)
    *   Убедитесь, что URL доступен с сервера Jeedom.
*   **Ключ API:**
    *   Скопируйте и вставьте ключ API, который вы сгенерировали в своем экземпляре n8n (в разделе `Настройки > API`).
    *   **Внимание:** Никогда не делитесь этим ключом. Он предоставляет доступ к вашему экземпляру n8n.

### Тест подключения

*   После ввода URL и ключа API нажмите кнопку **"Тест"**.
*   Jeedom попытается подключиться к вашему экземпляру n8n и получить список рабочих процессов, чтобы проверить правильность предоставленной информации.
*   Будет отображено сообщение об успехе или ошибке, указывающее, установлено ли соединение правильно.

## 4. Конфигурация оборудования (рабочих процессов)

Каждое оборудование Jeedom представляет собой конкретный рабочий процесс n8n, которым вы хотите управлять.

### Создание нового оборудования

1.  В Jeedom перейдите в `Плагины > n8n Connect`.
2.  Нажмите кнопку **"Добавить"**, чтобы создать новое оборудование.

### Общие параметры оборудования

*   **Имя оборудования:** Дайте четкое и описательное имя вашему оборудованию Jeedom (например, "Рабочий процесс полива сада", "Рабочий процесс уведомлений").
*   **Родительский объект:** Свяжите оборудование с существующим объектом Jeedom (например, "Сад", "Дом").
*   **Категория:** Назначьте одну или несколько категорий оборудованию (например, "Свет", "Безопасность").
*   **Опции:**
    *   **Активировать:** Установите этот флажок, чтобы активировать оборудование в Jeedom.
    *   **Видимый:** Установите этот флажок, чтобы сделать оборудование видимым на панели управления Jeedom.

### Специфические параметры рабочего процесса

*   **Рабочий процесс:**
    *   Нажмите кнопку обновления (<i class="fas fa-sync"></i>) рядом с полем, чтобы загрузить список всех доступных рабочих процессов в вашем экземпляре n8n.
    *   Выберите нужный рабочий процесс n8n, которым должно управлять это оборудование, из выпадающего списка.
    *   **В случае ошибки:** Если список не загружается (например, из-за проблемы с подключением к API или если рабочие процессы не найдены), появится поле для ручного ввода ID рабочего процесса. Вы можете найти ID вашего рабочего процесса в URL редактора n8n (например, `https://ваш.n8n.экземпляр/workflow/ВАШ_ID_РАБОЧЕГО_ПРОЦЕССА`).
*   **URL вебхука (необязательно):**
    *   Если вы хотите иметь возможность запускать этот рабочий процесс n8n с помощью команды "Запустить" из Jeedom, вы должны ввести его URL вебхука.
    *   Этот URL генерируется узлом "Webhook" вашего рабочего процесса n8n. Скопируйте полный URL (например, `https://ваш.n8n.экземпляр/webhook/ваш-уникальный-путь`).
    *   **Важно:** Если это поле пусто, команда "Запустить" не будет доступна для этого оборудования.
*   **Автообновление:** (Если доступно) Позволяет определить частоту, с которой Jeedom должен обновлять статус рабочего процесса (активен/неактивен) из n8n. Используйте помощник cron для определения расписания.

### Сохранение оборудования

*   После настройки всех параметров нажмите кнопку **"Сохранить"** в верхней части страницы.
*   Jeedom сохранит оборудование и автоматически создаст связанные команды (Активировать, Деактивировать, Статус и Запустить, если вебхук настроен).

## 5. Доступные команды

После сохранения оборудования будут доступны следующие команды:

### Команды действий

*   **Активировать:** Отправляет запрос в n8n для активации рабочего процесса, связанного с этим оборудованием. Рабочий процесс начнет выполняться в соответствии со своей конфигурацией (например, по триггеру).
*   **Деактивировать:** Отправляет запрос в n8n для деактивации рабочего процесса. Рабочий процесс прекратит выполнение и больше не будет реагировать на свои триггеры.
*   **Запустить:** (Видно только в том случае, если для оборудования настроен "URL вебхука"). Отправляет HTTP `POST`-запрос на указанный URL вебхука. Это запустит выполнение рабочего процесса n8n, как если бы вебхук был вызван извне.

### Информационные команды

*   **Статус:** Бинарная информационная команда (`0` или `1`), которая указывает текущий статус рабочего процесса в n8n:
    *   `1` (Активен): Рабочий процесс активирован и готов к выполнению.
    *   `0` (Неактивен): Рабочий процесс деактивирован.
    *   Эта информация обновляется во время автообновления или после действия активации/деактивации.

## 6. Устранение неполадок и распространенные ошибки

Вот наиболее часто встречающиеся проблемы и способы их решения.

### Ошибка HTTP 401 "несанкционированный доступ"

**Описание:** Эта ошибка указывает на проблему аутентификации при попытке подключения к API n8n.

**Возможные причины:**
*   Отсутствующий, неверный или истекший ключ API.
*   REST API не включен в n8n.
*   URL экземпляра n8n неверен или недоступен.
*   Проблема с разрешениями ключа API.

**Решения:**
1.  **Проверьте глобальную конфигурацию плагина:** Убедитесь, что **URL экземпляра n8n** и **Ключ API** правильно введены в `Плагины > Управление плагинами > n8n Connect > Конфигурация`.
2.  **Проверьте подключение:** Используйте кнопку **"Тест"** на этой же странице, чтобы проверить свои учетные данные и доступность экземпляра.
3.  **Проверьте n8n:**
    *   В вашем экземпляре n8n перейдите в `Настройки > API` и убедитесь, что REST API включен.
    *   Убедитесь, что используемый вами ключ API действительно тот, который был сгенерирован здесь, что он не истек и что у него есть необходимые разрешения (минимум `workflows.read`, `workflows.write`, `workflows.activate`, `workflows.deactivate`).
    *   Убедитесь, что ваш экземпляр n8n запущен и работает правильно.
4.  **Сетевое подключение:** Проверьте брандмауэры или проблемы с маршрутизацией сети, которые могут помешать Jeedom обмениваться данными с n8n по указанному порту.

### "Отсутствует URL вебхука"

**Описание:** Это сообщение появляется, когда вы пытаетесь выполнить команду "Запустить" для оборудования, но поле "URL вебхука" пусто в его конфигурации.

**Решение:**
*   Отредактируйте затронутое оборудование (`Плагины > n8n Connect`, нажмите на оборудование).
*   В специфических параметрах введите полный URL вебхука вашего рабочего процесса n8n в поле **"URL вебхука"**.
*   Сохраните оборудование. Команда "Запустить" теперь должна работать.

### "Ошибка вебхука: Запрошенный вебхук ... не зарегистрирован"

**Описание:** n8n указывает, что он не может найти вебхук, соответствующий URL, или что рабочий процесс не активен.

**Возможные причины:**
*   Рабочий процесс не активирован в n8n. Производственные вебхуки работают только в том случае, если рабочий процесс активен.
*   URL вебхука, введенный в Jeedom, неверен (опечатка, неверный ID вебхука и т. д.).
*   Узел "Webhook" в вашем рабочем процессе n8n не настроен на прием `POST`-запросов (хотя это поведение по умолчанию).

**Решения:**
1.  **Активируйте рабочий процесс в n8n:** Откройте свой рабочий процесс в n8n и убедитесь, что кнопка `Активен` (в правом верхнем углу редактора) установлена в `ON`.
2.  **Проверьте URL вебхука:** Скопируйте URL вебхука непосредственно из узла "Webhook" вашего рабочего процесса n8n и снова вставьте его в поле "URL вебхука" оборудования Jeedom, чтобы избежать ошибок.
3.  **Метод HTTP:** Плагин отправляет `POST`-запрос. Убедитесь, что ваш узел "Webhook" в n8n настроен на прием `POST`-запросов (это значение по умолчанию для производственных вебхуков).

### "Время ожидания истекло"

**Описание:** Jeedom не получил ответа от n8n в течение отведенного времени (по умолчанию 30 секунд).

**Возможные причины:**
*   Ваш экземпляр n8n остановлен или не отвечает.
*   Проблема с сетевым подключением между Jeedom и n8n (брандмауэр, маршрутизатор и т. д.).
*   Экземпляр n8n перегружен или очень медленно отвечает.

**Решения:**
1.  **Проверьте статус n8n:** Убедитесь, что ваш экземпляр n8n запущен и доступен через браузер или `ping` с сервера Jeedom.
2.  **Проверьте подключение:** Проверьте сетевое подключение между вашим Jeedom и n8n. Например, из терминала Jeedom попробуйте `curl -v ВАШ_URL_N8N`.
3.  **Производительность n8n:** Если n8n перегружен, рассмотрите возможность оптимизации ваших рабочих процессов или увеличения ресурсов, выделенных вашему экземпляру n8n.

### Диагностические логи

Для получения более подробной информации об ошибках обратитесь к логам плагина n8n Connect:

1.  В Jeedom перейдите в `Инструменты > Логи`.
2.  В выпадающем списке выберите `n8nconnect`.
3.  Логи отображают связь между Jeedom и n8n, включая отправленные запросы и полученные ответы, что крайне важно для устранения неполадок.

## Уведомления об ошибках рабочего процесса

Чтобы получать уведомления об ошибках рабочих процессов n8n непосредственно в Jeedom, вы можете настроить глобальный "Рабочий процесс ошибок" в n8n, который будет отправлять HTTP-запрос в Jeedom.

### Конфигурация в n8n

1.  **Создайте новый рабочий процесс** в n8n (или используйте существующий рабочий процесс, предназначенный для ошибок).
2.  Добавьте узел **"Webhook"** в качестве триггера. Настройте его для прослушивания `POST`-запросов.
3.  Добавьте узел **"HTTP-запрос"** после узла "Webhook".
    *   **Метод:** `POST`
    *   **URL:** `http://ВАШ_IP_JEEDOM/plugins/n8nconnect/core/ajax/n8nconnect.ajax.php?action=receiveErrorNotification`
        *   Замените `ВАШ_IP_JEEDOM` на IP-адрес или доменное имя вашей установки Jeedom.
    *   **Тип содержимого тела:** `JSON`
    *   **Тело JSON:** Вы можете отправить любые соответствующие данные JSON. Например, чтобы отправить информацию об ошибке из завершившегося с ошибкой рабочего процесса, вы можете использовать выражение, подобное этому:
        ```json
        {
          "workflowName": "{{ $json.workflow.name }}",
          "workflowId": "{{ $json.workflow.id }}",
          "executionId": "{{ $json.id }}",
          "error": "{{ $json.error.message }}",
          "stackTrace": "{{ $json.error.stack }}"
        }
        ```
        Эти переменные (`$json.workflow.name`, etc.) доступны в контексте рабочего процесса ошибок n8n.
4.  **Активируйте этот рабочий процесс** в n8n.
5.  **Настройте этот рабочий процесс как глобальный "Рабочий процесс ошибок":**
    *   В n8n перейдите в **Настройки > Обработка ошибок рабочего процесса**.
    *   Выберите только что созданный рабочий процесс из выпадающего списка "Рабочий процесс ошибок".

### Обработка в Jeedom

Плагин n8n Connect будет получать эти уведомления и записывать их в логи плагина (`Инструменты > Логи > n8nconnect`). Затем вы можете использовать сценарии Jeedom для анализа этих логов и запуска действий (уведомлений, предупреждений и т. д.) на основе содержимого сообщений об ошибках.

## 7. Поддержка

Если вы столкнулись с постоянными проблемами после выполнения этого руководства, пожалуйста, соберите следующую информацию, прежде чем обращаться за помощью:

*   Точная версия Jeedom (видна в `Настройки > Система > Конфигурация > Общие`).
*   Версия вашего экземпляра n8n.
*   Полные и точные сообщения об ошибках, скопированные непосредственно из логов Jeedom `n8nconnect`.
*   Скриншот страницы глобальной конфигурации плагина (скройте ваш ключ API).
*   Скриншот страницы конфигурации затронутого оборудования Jeedom.
*   Подробное описание шагов для воспроизведения проблемы.